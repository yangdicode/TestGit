package mmo.framework.domain.fairy
{
	import flash.system.ApplicationDomain;

	internal class FairyLvExpMap
	{
		public function FairyLvExpMap()
		{
		}
		
		internal static function getFairyLvByLv(fairyId:int, fairyLv:int):FairyLevel
		{
			var fairy:Fairy = Fairys.getFairyById(fairyId);
			var key:String = fairyId + "_" + fairyLv;
				
			if(fairyLv == 1 || fairyLv == fairy.maxLevel)
			{
				return LV_DEFINE_DATA[key] as FairyLevel;
			}
			
			var lv1:FairyLevel = LV_DEFINE_DATA[fairyId + "_" + 1] as FairyLevel;
			var lvMax:FairyLevel =LV_DEFINE_DATA[fairyId + "_" + fairy.maxLevel] as FairyLevel;
			
			var expType:int = getExpTypeByFairyId(fairyId);
			var rsExp:int = getLvExpByType(fairyLv, expType);
			var rsAtk:int = int(lv1.attack + (fairyLv - 1) * getAve(lvMax.attack, lv1.attack, fairy.maxLevel));
			var rsRecover:int =  int(lv1.recover + (fairyLv - 1) * getAve(lvMax.recover, lv1.recover, fairy.maxLevel));
			var rsHp:int = int(lv1.hp + (fairyLv - 1) * getAve(lvMax.hp, lv1.hp, fairy.maxLevel));
			var rsOfferExp:int = lv1.affordExp * fairyLv;
			
			return new FairyLevel(fairyId, fairyLv, rsAtk, rsRecover, rsHp, rsExp, rsOfferExp);
		}
		
		internal static function getFairyLvByExp(fairyId:int, exp:int):FairyLevel
		{
			var fairy:Fairy = Fairys.getFairyById(fairyId);
			var expType:int = getExpTypeByFairyId(fairyId);
			var dataArr:Array = objectToArr(EXP_MAP[expType]);
			var targetLv:int = 1;
			
			for(var i:int = dataArr.length - 1; i>= 0; i--) 
			{
				if (exp >= dataArr[i]) 
				{
					targetLv = i + 1;
					break;
				}
			}
			//因为服务端没有帮忙截取超过最高等级的经验，所以这里特殊截一下
			if(targetLv > fairy.maxLevel)
			{
				targetLv = fairy.maxLevel;
			}
			
			return getFairyLvByLv(fairyId, targetLv);
		}
		
		private static function getAve(LvMaxValue:int, lv1Value:int, maxLv:int):Number {
			return (LvMaxValue - lv1Value) / (maxLv - 1);
		}
		
		private static function getExpTypeByFairyId(fairyId:int):int
		{
			var fairy:Fairy = Fairys.getFairyById(fairyId);
			var lvMax:FairyLevel = LV_DEFINE_DATA[fairyId + "_" + fairy.maxLevel] as FairyLevel;
			
			for(var key:String in EXP_MAP)
			{
				if(EXP_MAP[key][lvMax.level] == lvMax.needExp)
				{
					return int(key);
				}
			}
			throw new Error("Error:找不到级数为"+ lvMax.level + "经验为" + lvMax.needExp + "的经验曲线");
			return -1;
		}
		
		private static function getLvExpByType(lv:int, expType:int):int
		{
			return int(EXP_MAP[expType][lv]);
		}
		
		private static function objectToArr(obj:Object):Array
		{
			var arr:Array = [];
			for(var key:String in obj)
			{
				arr[int(key) - 1] = obj[key];
			}
			return arr;
		}
		
		private static const LV_DEFINE_DATA:Object = ApplicationDomain.currentDomain.getDefinition("mmo.materialdata.fairy.FairyLevelsData")["data"];
		
		private static const EXP_MAP:Object = 
			{
				"0":{
					"1" :0,
					"2" :11,
					"3" :59,
					"4" :164,
					"5" :337,
					"6" :588,
					"7" :927,
					"8" :1364,
					"9" :1904,
					"10" :2556,
					"11" :3326,
					"12" :4221,
					"13" :5247,
					"14" :6409,
					"15" :7714,
					"16" :9166,
					"17" :10770,
					"18" :12533,
					"19" :14458,
					"20" :16551,
					"21" :18815,
					"22" :21256,
					"23" :23878,
					"24" :26684,
					"25" :29680,
					"26" :32869,
					"27" :36255,
					"28" :39842,
					"29" :43634,
					"30" :47635,
					"31" :51849,
					"32" :56278,
					"33" :60927,
					"34" :65799,
					"35" :70898,
					"36" :76226,
					"37" :81788,
					"38" :87587,
					"39" :93625,
					"40" :99907,
					"41" :106435,
					"42" :113213,
					"43" :120243,
					"44" :127528,
					"45" :135072,
					"46" :142878,
					"47" :150949,
					"48" :159287,
					"49" :167895,
					"50" :176777,
					"51" :185934,
					"52" :195371,
					"53" :205089,
					"54" :215092,
					"55" :225382,
					"56" :235962,
					"57" :246834,
					"58" :258001,
					"59" :269467,
					"60" :281232,
					"61" :293301,
					"62" :305675,
					"63" :318357,
					"64" :331349,
					"65" :344655,
					"66" :358276,
					"67" :372216,
					"68" :386475,
					"69" :401058,
					"70" :415966,
					"71" :431201,
					"72" :446767,
					"73" :462664,
					"74" :478897,
					"75" :495466,
					"76" :512375,
					"77" :529625,
					"78" :547220,
					"79" :565160,
					"80" :583449,
					"81" :602088,
					"82" :621080,
					"83" :640427,
					"84" :660131,
					"85" :680194,
					"86" :700619,
					"87" :721408,
					"88" :742562,
					"89" :764085,
					"90" :785977,
					"91" :808241,
					"92" :830880,
					"93" :853895,
					"94" :877288,
					"95" :901062,
					"96" :925217,
					"97" :949758,
					"98" :974685,
					"99" :1000000
				},
				"1":{"1" :0,
					"2" :16,
					"3" :89,
					"4" :246,
					"5" :505,
					"6" :882,
					"7" :1391,
					"8" :2045,
					"9" :2856,
					"10" :3834,
					"11" :4989,
					"12" :6332,
					"13" :7870,
					"14" :9614,
					"15" :11570,
					"16" :13748,
					"17" :16156,
					"18" :18800,
					"19" :21687,
					"20" :24826,
					"21" :28223,
					"22" :31884,
					"23" :35816,
					"24" :40026,
					"25" :44520,
					"26" :49303,
					"27" :54383,
					"28" :59763,
					"29" :65452,
					"30" :71453,
					"31" :77773,
					"32" :84417,
					"33" :91390,
					"34" :98699,
					"35" :106347,
					"36" :114339,
					"37" :122682,
					"38" :131380,
					"39" :140438,
					"40" :149861,
					"41" :159653,
					"42" :169819,
					"43" :180364,
					"44" :191292,
					"45" :202609,
					"46" :214317,
					"47" :226423,
					"48" :238930,
					"49" :251843,
					"50" :265165,
					"51" :278902,
					"52" :293057,
					"53" :307634,
					"54" :322638,
					"55" :338073,
					"56" :353943,
					"57" :370251,
					"58" :387002,
					"59" :404200,
					"60" :421848,
					"61" :439951,
					"62" :458512,
					"63" :477535,
					"64" :497024,
					"65" :516983,
					"66" :537415,
					"67" :558323,
					"68" :579713,
					"69" :601587,
					"70" :623949,
					"71" :646802,
					"72" :670150,
					"73" :693997,
					"74" :718345,
					"75" :743199,
					"76" :768563,
					"77" :794438,
					"78" :820829,
					"79" :847740,
					"80" :875173,
					"81" :903132,
					"82" :931620,
					"83" :960640,
					"84" :990196,
					"85" :1020292,
					"86" :1050929,
					"87" :1082112,
					"88" :1113844,
					"89" :1146127,
					"90" :1178965,
					"91" :1212362,
					"92" :1246320,
					"93" :1280842,
					"94" :1315932,
					"95" :1351592,
					"96" :1387826,
					"97" :1424637,
					"98" :1462027,
					"99" :1500000},
				"2":{
					"1" :0,
					"2" :21,
					"3" :119,
					"4" :328,
					"5" :673,
					"6" :1176,
					"7" :1855,
					"8" :2727,
					"9" :3808,
					"10" :5112,
					"11" :6652,
					"12" :8442,
					"13" :10493,
					"14" :12818,
					"15" :15427,
					"16" :18331,
					"17" :21541,
					"18" :25066,
					"19" :28917,
					"20" :33102,
					"21" :37630,
					"22" :42512,
					"23" :47755,
					"24" :53368,
					"25" :59360,
					"26" :65738,
					"27" :72510,
					"28" :79685,
					"29" :87269,
					"30" :95271,
					"31" :103697,
					"32" :112556,
					"33" :121854,
					"34" :131598,
					"35" :141795,
					"36" :152453,
					"37" :163577,
					"38" :175174,
					"39" :187251,
					"40" :199814,
					"41" :212870,
					"42" :226425,
					"43" :240485,
					"44" :255056,
					"45" :270145,
					"46" :285756,
					"47" :301897,
					"48" :318573,
					"49" :335790,
					"50" :353553,
					"51" :371869,
					"52" :390742,
					"53" :410179,
					"54" :430184,
					"55" :450764,
					"56" :471923,
					"57" :493668,
					"58" :516003,
					"59" :538933,
					"60" :562464,
					"61" :586601,
					"62" :611349,
					"63" :636713,
					"64" :662699,
					"65" :689310,
					"66" :716553,
					"67" :744431,
					"68" :772951,
					"69" :802116,
					"70" :831931,
					"71" :862402,
					"72" :893533,
					"73" :925329,
					"74" :957794,
					"75" :990933,
					"76" :1024750,
					"77" :1059251,
					"78" :1094439,
					"79" :1130320,
					"80" :1166897,
					"81" :1204175,
					"82" :1242159,
					"83" :1280853,
					"84" :1320262,
					"85" :1360389,
					"86" :1401239,
					"87" :1442816,
					"88" :1485125,
					"89" :1528169,
					"90" :1571954,
					"91" :1616483,
					"92" :1661760,
					"93" :1707790,
					"94" :1754576,
					"95" :1802123,
					"96" :1850435,
					"97" :1899516,
					"98" :1949369,
					"99" :2000000
				},
				"3":{
					"1" :0,
					"2" :26,
					"3" :149,
					"4" :410,
					"5" :841,
					"6" :1470,
					"7" :2319,
					"8" :3409,
					"9" :4760,
					"10" :6390,
					"11" :8315,
					"12" :10553,
					"13" :13117,
					"14" :16023,
					"15" :19284,
					"16" :22914,
					"17" :26926,
					"18" :31333,
					"19" :36146,
					"20" :41377,
					"21" :47038,
					"22" :53140,
					"23" :59694,
					"24" :66711,
					"25" :74200,
					"26" :82172,
					"27" :90638,
					"28" :99606,
					"29" :109086,
					"30" :119088,
					"31" :129622,
					"32" :140695,
					"33" :152317,
					"34" :164498,
					"35" :177244,
					"36" :190566,
					"37" :204471,
					"38" :218967,
					"39" :234064,
					"40" :249768,
					"41" :266088,
					"42" :283031,
					"43" :300606,
					"44" :318820,
					"45" :337681,
					"46" :357196,
					"47" :377372,
					"48" :398217,
					"49" :419738,
					"50" :441942,
					"51" :464836,
					"52" :488428,
					"53" :512723,
					"54" :537730,
					"55" :563455,
					"56" :589904,
					"57" :617085,
					"58" :645003,
					"59" :673666,
					"60" :703080,
					"61" :733251,
					"62" :764187,
					"63" :795892,
					"64" :828373,
					"65" :861638,
					"66" :895691,
					"67" :930539,
					"68" :966188,
					"69" :1002645,
					"70" :1039914,
					"71" :1078003,
					"72" :1116916,
					"73" :1156661,
					"74" :1197242,
					"75" :1238666,
					"76" :1280938,
					"77" :1324063,
					"78" :1368049,
					"79" :1412900,
					"80" :1458621,
					"81" :1505219,
					"82" :1552699,
					"83" :1601067,
					"84" :1650327,
					"85" :1700486,
					"86" :1751548,
					"87" :1803520,
					"88" :1856406,
					"89" :1910212,
					"90" :1964942,
					"91" :2020603,
					"92" :2077200,
					"93" :2134737,
					"94" :2193220,
					"95" :2252654,
					"96" :2313044,
					"97" :2374395,
					"98" :2436712,
					"99" :2500000},
				"4":{
					"1" :0,
					"2" :32,
					"3" :178,
					"4" :492,
					"5" :1010,
					"6" :1764,
					"7" :2782,
					"8" :4091,
					"9" :5712,
					"10" :7668,
					"11" :9978,
					"12" :12663,
					"13" :15740,
					"14" :19227,
					"15" :23141,
					"16" :27497,
					"17" :32311,
					"18" :37599,
					"19" :43375,
					"20" :49652,
					"21" :56446,
					"22" :63768,
					"23" :71633,
					"24" :80053,
					"25" :89040,
					"26" :98607,
					"27" :108765,
					"28" :119527,
					"29" :130903,
					"30" :142906,
					"31" :155546,
					"32" :168834,
					"33" :182781,
					"34" :197397,
					"35" :212693,
					"36" :228679,
					"37" :245365,
					"38" :262761,
					"39" :280876,
					"40" :299721,
					"41" :319305,
					"42" :339638,
					"43" :360728,
					"44" :382584,
					"45" :405217,
					"46" :428635,
					"47" :452846,
					"48" :477860,
					"49" :503685,
					"50" :530330,
					"51" :557803,
					"52" :586113,
					"53" :615268,
					"54" :645276,
					"55" :676146,
					"56" :707885,
					"57" :740502,
					"58" :774004,
					"59" :808400,
					"60" :843696,
					"61" :879902,
					"62" :917024,
					"63" :955070,
					"64" :994048,
					"65" :1033965,
					"66" :1074829,
					"67" :1116647,
					"68" :1159426,
					"69" :1203174,
					"70" :1247897,
					"71" :1293603,
					"72" :1340300,
					"73" :1387993,
					"74" :1436690,
					"75" :1486399,
					"76" :1537125,
					"77" :1588876,
					"78" :1641659,
					"79" :1695480,
					"80" :1750346,
					"81" :1806263,
					"82" :1863239,
					"83" :1921280,
					"84" :1980393,
					"85" :2040583,
					"86" :2101858,
					"87" :2164224,
					"88" :2227687,
					"89" :2292254,
					"90" :2357931,
					"91" :2424724,
					"92" :2492640,
					"93" :2561684,
					"94" :2631864,
					"95" :2703185,
					"96" :2775652,
					"97" :2849274,
					"98" :2924054,
					"99" :3000000},
				"5":{
					"1" :0,
					"2" :42,
					"3" :238,
					"4" :656,
					"5" :1346,
					"6" :2352,
					"7" :3710,
					"8" :5454,
					"9" :7616,
					"10" :10224,
					"11" :13304,
					"12" :16884,
					"13" :20987,
					"14" :25636,
					"15" :30854,
					"16" :36663,
					"17" :43082,
					"18" :50132,
					"19" :57833,
					"20" :66203,
					"21" :75261,
					"22" :85024,
					"23" :95511,
					"24" :106737,
					"25" :118720,
					"26" :131475,
					"27" :145020,
					"28" :159369,
					"29" :174538,
					"30" :190542,
					"31" :207395,
					"32" :225112,
					"33" :243708,
					"34" :263196,
					"35" :283591,
					"36" :304905,
					"37" :327153,
					"38" :350348,
					"39" :374502,
					"40" :399628,
					"41" :425740,
					"42" :452850,
					"43" :480970,
					"44" :510112,
					"45" :540289,
					"46" :571513,
					"47" :603795,
					"48" :637147,
					"49" :671580,
					"50" :707107,
					"51" :743738,
					"52" :781484,
					"53" :820358,
					"54" :860368,
					"55" :901528,
					"56" :943847,
					"57" :987336,
					"58" :1032005,
					"59" :1077866,
					"60" :1124928,
					"61" :1173202,
					"62" :1222699,
					"63" :1273427,
					"64" :1325398,
					"65" :1378621,
					"66" :1433106,
					"67" :1488863,
					"68" :1545901,
					"69" :1604232,
					"70" :1663863,
					"71" :1724805,
					"72" :1787066,
					"73" :1850657,
					"74" :1915587,
					"75" :1981865,
					"76" :2049500,
					"77" :2118502,
					"78" :2188878,
					"79" :2260639,
					"80" :2333794,
					"81" :2408351,
					"82" :2484319,
					"83" :2561707,
					"84" :2640523,
					"85" :2720777,
					"86" :2802477,
					"87" :2885632,
					"88" :2970250,
					"89" :3056339,
					"90" :3143908,
					"91" :3232966,
					"92" :3323520,
					"93" :3415579,
					"94" :3509152,
					"95" :3604246,
					"96" :3700870,
					"97" :3799031,
					"98" :3898739,
					"99" :4000000
				}
			}
	}
}